# GitLab CI/CD for Next.js (GitLab Pages)
# - Builds on every commit to main
# - Tries to statically export; if not possible, publishes a fallback page that explains

image: node:20-bullseye

variables:
  PNPM_HOME: "$CI_PROJECT_DIR/.pnpm"
  PATH: "$PNPM_HOME:$PATH"
  NEXT_TELEMETRY_DISABLED: "1"
  # Next.js cache dir
  NEXT_CACHE_DIR: ".next/cache"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - node_modules/
    - .next/cache/
    - .pnpm-store/

stages:
  - install
  - build
  - pages

.pnpm_setup: &pnpm_setup |
  corepack enable
  corepack prepare pnpm@latest --activate

install:
  stage: install
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - *pnpm_setup
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - pnpm-lock.yaml
    expire_in: 1 day

build:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs: ["install"]
  before_script:
    - *pnpm_setup
  script:
    - pnpm run build
  artifacts:
    paths:
      - .next/
    expire_in: 1 day

pages:
  stage: pages
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs:
    - job: install
      artifacts: true
    - job: build
      artifacts: true
  before_script:
    - *pnpm_setup
  script:
    - |
      set -euo pipefail
      # Prepare public directory for Pages
      rm -rf public_pages
      mkdir -p public_pages

      # Attempt static export (Next 15): `next export` is supported for static routes
      # If export fails, generate a simple info page
      if pnpm exec next export -o public_pages; then
        echo "Static export succeeded"
      else
        echo "Static export failed; creating fallback page"
        cat > public_pages/index.html << 'EOF'
        <!doctype html>
        <html lang="en">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>Cash Register</title>
          <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; padding: 2rem; line-height: 1.5; }
            .wrap { max-width: 720px; margin: 0 auto; }
            code { background: #f2f2f2; padding: 0.1rem 0.3rem; border-radius: 4px; }
          </style>
        </head>
        <body>
          <div class="wrap">
            <h1>Cash Register</h1>
            <p>This project is a Next.js app which relies on server-side features and Supabase. It cannot be fully exported to static HTML for GitLab Pages.</p>
            <p>The CI pipeline validated the build successfully. To run the dynamic app, deploy to a Node.js runtime (e.g., GitLab Auto DevOps, Railway, Vercel, or a custom server) and run <code>pnpm start</code> after <code>pnpm build</code>.</p>
            <p>Source commit: ${CI_COMMIT_SHORT_SHA}</p>
          </div>
        </body>
        </html>
        EOF
      fi
    - mv public_pages public
  artifacts:
    paths:
      - public


