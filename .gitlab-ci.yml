image: node:18

# Define variables
variables:
  NODE_ENV: production
  CI_COMMIT_REF_SLUG: $CI_COMMIT_REF_SLUG

# Cache node_modules for faster builds
cache:
  paths:
    - node_modules/
    - .next/cache/

variables:
  PNPM_HOME: "$CI_PROJECT_DIR/.pnpm"
  PATH: "$PNPM_HOME:$PATH"
  NEXT_TELEMETRY_DISABLED: "1"
  # Next.js cache dir
  NEXT_CACHE_DIR: ".next/cache"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - node_modules/
    - .next/cache/
    - .pnpm-store/

stages:
  - install
  - build
  - pages

.pnpm_setup: &pnpm_setup |
  corepack enable
  corepack prepare pnpm@latest --activate

install:
  stage: install
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - *pnpm_setup
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - pnpm-lock.yaml
    expire_in: 1 day

build:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs: ["install"]
  before_script:
    - *pnpm_setup
  script:
    - pnpm run build
  artifacts:
    paths:
      - out/
    expire_in: 1 day

# Deploy to GitLab Pages - Production (main branch)
pages:
  stage: pages
  script:
    - echo "Deploying to GitLab Pages Production..."
    - echo "Production URL - ${CI_PAGES_URL}"
    - ls -la out/  # Debug: List contents of out directory
    - mkdir -p public
    - cp -r out/* public/  # Copy contents of out directory to public directory
    - ls -la public/  # Debug: List contents of public directory
    - ls -la public/_next/static/chunks/ || echo "No chunks directory found"
  artifacts:
    paths:
      - public/
    expire_in: never
  dependencies:
    - build
    #- test
  environment:
    name: production
    url: $CI_PAGES_URL
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH


